
f250727b(
  x1=data.table(t0=as.Date("1996-05-12"),t1=as.Date("1997-05-30"),p0=1000,p1=2000),
  x2=as.Date(c("1994-12-31", "1996-05-12", "1996-12-07", "1997-05-30", "1997-10-21"))
  )






# --- Data ---
x1 <- fread("
  t0,t1,p0,p1
  1997-01-30,2000-09-01,157136,263773
") %>%
  .[, `:=`(
    t0 = as.Date(t0), t1 = as.Date(t1),
    p0 = as.numeric(p0), p1 = as.numeric(p1)
  )] %>%
  .[]
x2 <- as.IDate(c(
  "1994-12-31", "1996-05-12", "1996-12-07", "1997-05-30", "1997-10-21"
))

x1
# x1 <- fread("
#   t0,t1,p0,p1
#   1997-01-30,2000-09-01,157136,263773
#   1997-06-06,2000-05-26,119356,184720
#   2000-05-26,2005-03-11,184720,284395
#   2005-03-11,2020-04-03,284395,517146
#   2020-04-03,2025-02-07,517146,631571
#   1997-06-20,1999-12-22,119356,163156
#   1999-12-22,2010-07-28,163156,352509
#   2010-07-28,2017-08-11,352509,549781
#   1997-06-20,2000-06-16,141239,241208
#   1997-07-31,2003-02-17,146957,328417
# ") %>%
#   .[, `:=`(
#     t0 = as.IDate(t0), t1 = as.IDate(t1),
#     p0 = as.numeric(p0), p1 = as.numeric(p1)
#   )] %>%
#   .[]
# 
# x2 <- as.IDate(c(
#   "1994-12-31", "1996-05-12", "1996-12-07", "1997-05-30", "1997-10-21",
#   "1998-07-01", "1999-04-16", "1999-08-23", "1999-12-19", "2000-02-22",
#   "2001-09-02", "2002-05-01", "2002-08-31", "2002-12-17", "2003-04-05",
#   "2003-06-14", "2003-08-23", "2003-11-07", "2004-01-27", "2004-04-21",
#   "2004-06-10", "2004-11-06", "2005-05-26", "2006-07-11", "2007-01-30",
#   "2007-05-17", "2007-12-31", "2009-02-28", "2009-06-09", "2010-02-16",
#   "2011-03-28", "2011-10-11", "2012-08-04", "2013-10-08", "2014-05-26",
#   "2014-08-27", "2015-04-08", "2015-10-18", "2016-01-27", "2016-05-29",
#   "2016-10-27", "2017-07-16", "2018-05-07", "2020-01-30", "2021-07-08",
#   "2022-08-04", "2025-02-28"
# ))

# f250727b <-
#   function(
#       x1,
#       x2) {
#     x4 <-
#       1:(length(x2) - 1)
#     x5 <- # Find intervals (left-open, right-closed)
#       findInterval(x1$t0, x2, rightmost.closed = TRUE, left.open = TRUE)
#     x6 <-
#       findInterval(x1$t1, x2, rightmost.closed = TRUE, left.open = TRUE)
#     x7 <- # Build long format
#       rbind(
#         data.table(row_id = seq_len(nrow(x1)), interval = x5, value = x1$p0),
#         data.table(row_id = seq_len(nrow(x1)), interval = x6, value = x1$p1)
#       )[interval > 0 & interval <= (length(x2) - 1)]
#     x8 <- # Ensure all interval rows exist
#       CJ(row_id = seq_len(nrow(x1)), interval = x4)
#     x9 <- # place values on grid
#       x7[x8, on = c(row_id = "row_id", interval = "interval")]
#     x9[is.na(value), value := 0]
#     x10 <- # Pivot to wide
#       dcast(x9, row_id ~ interval, value.var = "value", fill = 0)
#     x11 <- # rename to rh date boundary
#       setnames(x10, old = as.character(x4), new = as.character(x2[-1]))
#     x12 <- # join x1
#       x10 %>%
#       .[x1[, row_id := .I], on = c(row_id = "row_id")] %>%
#       .[, -"row_id"]
#     x12
#   }

f250727b(x1,x2)
